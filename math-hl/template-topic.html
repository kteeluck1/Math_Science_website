<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{TITLE}} | Math HL</title>
  <style>
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px; color:#0f172a; background:#fff }
    a{ color:#2563eb }
    .nav{ display:flex; gap:12px; align-items:center; margin-bottom:18px }
    .actions{ margin-left:auto }
    .signup{ padding:8px 12px; border-radius:999px; background:#f97316; color:#fff; font-weight:800; text-decoration:none }
    .card{ border:1px solid #e5e7eb; border-radius:12px; padding:18px; margin-bottom:12px; background:#fff }
    .meta{ color:#64748b; font-weight:700 }
    .navlinks{ margin-top:12px }
    .pager{ display:flex; gap:12px; margin-top:18px }
    .btn{ padding:8px 10px; border-radius:8px; background:#2563eb; color:#fff; text-decoration:none; font-weight:800 }
    .problem{ font-weight:800 }
    .solution{ margin-top:12px; padding:12px; border-radius:8px; background:#f8fafc; display:none }
    /* Page-local: make buttons inside problem card appear as outline with bold blue text */
    .card .btn{ background:#fff; color:#2563eb; border:1px solid #2563eb; font-weight:800 }
    .card .btn:hover{ background:#f1f5f9 }
    /* Highlight step container while narration is playing */
    .speaking{ background:linear-gradient(90deg, rgba(245,250,255,0.6), rgba(255,249,230,0.8)); box-shadow:inset 0 0 0 1px rgba(99,102,241,0.03); transition:background 0.2s ease }
    /* Inline word highlighting */
    .speak-text{ margin-top:8px; color:#0f172a }
    .speak-text .word{ padding:0 2px; border-radius:2px }
    .speak-text .speaking-word{ background:#fff3bf }
    </style>
    <script>
      window.MathJax = { tex: { inlineMath: [['\\(','\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script>
      // Toggle show/hide solution for topic pages
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('button[data-target]').forEach(function(b){
          b.addEventListener('click', function(){
            var id = b.getAttribute('data-target');
            var el = document.getElementById(id);
            if (!el) return;
            if (el.style.display === 'block'){
              el.style.display = 'none';
              b.textContent = 'Show solution';
            } else {
              el.style.display = 'block';
              b.textContent = 'Hide solution';
            }
          });
        });

        // Per-step speech support with inline highlighting
        if (!('speechSynthesis' in window)) return;
        (function(){
          var currentUtterance = null;
          var currentBtn = null;
          var currentContainer = null;

          function resetBtn(btn){ if (!btn) return; btn.textContent = btn.dataset.label || btn.getAttribute('aria-label') || 'ðŸ”Š Listen'; }

          document.querySelectorAll('.listen-step').forEach(function(btn,index){
            btn.dataset.label = btn.textContent;
            btn.addEventListener('click', function(){
              var text = btn.getAttribute('data-text') || '';
              if (currentUtterance){
                if (currentBtn === btn){
                  window.speechSynthesis.cancel();
                  currentUtterance = null;
                  if (currentContainer) { currentContainer.classList.remove('speaking'); currentContainer = null; }
                  resetBtn(currentBtn);
                  currentBtn = null;
                  return;
                }
                window.speechSynthesis.cancel();
                if (currentBtn) resetBtn(currentBtn);
                if (currentContainer) { currentContainer.classList.remove('speaking'); currentContainer = null; }
              }

              currentBtn = btn;
              btn.textContent = 'â–  Stop';
              var container = btn.closest('[id^="step"]');
              if (container){ container.classList.add('speaking'); currentContainer = container; }

              var u = new SpeechSynthesisUtterance(text);
              u.rate = 1; u.pitch = 1; u.lang = 'en-US';

              var spans = container ? Array.from(container.querySelectorAll('.speak-text .word')) : [];
              if (spans.length){
                var joined = spans.map(function(s){ return s.textContent; }).join(' ');
                var idx = 0; var wordOffsets = [];
                joined.split(/\s+/).forEach(function(w){ wordOffsets.push(idx); idx += w.length + 1; });
                var boundarySeen = false;
                var fallbackInterval = null;
                function clearFallback(){ if (fallbackInterval){ clearInterval(fallbackInterval); fallbackInterval = null; } }
                u.onstart = function(){ boundarySeen = false; clearFallback(); };
                u.onboundary = function(ev){
                  try{
                    boundarySeen = true;
                    var charIndex = (typeof ev.charIndex === 'number') ? ev.charIndex : 0;
                    var wi = 0;
                    for (var k=0;k<wordOffsets.length;k++){
                      if (wordOffsets[k] <= charIndex) wi = k; else break;
                    }
                    if (wi < 0) wi = 0; if (wi >= spans.length) wi = spans.length - 1;
                    spans.forEach(function(s){ s.classList.remove('speaking-word'); });
                    if (spans[wi]) spans[wi].classList.add('speaking-word');
                  }catch(e){}
                };
                // Fallback: if boundary events are not provided reliably, simulate per-word highlighting
                u.onstart = (function(orig){ return function(){ if (orig) orig(); boundarySeen = false; clearFallback();
                  // after 250ms, if no boundarySeen, start fallback highlighting
                  setTimeout(function(){ if (boundarySeen) return; var wi = 0; var perWordMs = Math.max(220, Math.min(800, Math.round(600 / (u.rate || 1))));
                      fallbackInterval = setInterval(function(){ spans.forEach(function(s){ s.classList.remove('speaking-word'); }); if (spans[wi]) spans[wi].classList.add('speaking-word'); wi++; if (wi >= spans.length) { clearFallback(); } }, perWordMs);
                  }, 250);
                }; })(u.onstart);
                u.onend = (function(orig){ return function(){ clearFallback(); if (orig) orig(); }; })(u.onend);
              }

              u.onend = function(){ resetBtn(btn); currentUtterance = null; currentBtn = null; if (currentContainer) { currentContainer.classList.remove('speaking'); currentContainer = null; } if (spans.length) spans.forEach(function(s){ s.classList.remove('speaking-word'); }); };

              currentUtterance = u; window.speechSynthesis.speak(u);
            });
          });
        })();
      });
    </script>
  </head>
<body>
  <div class="nav">
    <a href="../index.html">Home</a>
    <a href="../math-hl.html">Courses</a>
    <strong>â€º</strong>
    <span>{{TITLE}}</span>
    <div class="actions">
      <a class="signup" href="../math-hl.html#signup">Sign Up for Free</a>
    </div>
  </div>

  <h1>{{TITLE}}</h1>
  <div class="meta">Math HL â€” topic page</div>

  <div class="card">
    <p>{{DESCRIPTION}}</p>
    <p class="navlinks">Edit this file to add problems, worked solutions, videos or links to PDFs.</p>
  </div>

  <div class="pager">
    {{PREV_LINK}}
    <a class="btn" href="../math-hl.html">Back to Topics</a>
    {{NEXT_LINK}}
  </div>

</body>
</html>
